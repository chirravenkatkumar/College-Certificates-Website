<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload PDF, Image, or CSV and Select Positions</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.css"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="/uploadpage.css">
    <style>
        /* CSS for modal popup */
        .modal {
            display: none; /* Hidden by default */
            position: relative; /* Relative positioning for the parent */
            margin-top: 20px; /* Adjust as needed */
        }
        .modal-content {
            background-color: #fefefe;
            padding: 0; /* Adjust padding */
            border: 1px solid #888;
            width: 100%; /* Full width */
            height: 500px; /* Fixed height */
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
            overflow: hidden; /* Hide scrollbars */
            position: relative; /* Added */
        }
        /* Close button style */
        .close {
            color: #aaa;
            position: absolute; /* Adjust position */
            top: 10px; /* Adjust top */
            right: 10px; /* Adjust right */
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }
        /* CSS for canvas */
        #pdfViewer canvas {
            display: block;
            margin: 0 auto; /* Center horizontally */
            max-width: 100%; /* Ensure the canvas does not exceed the modal width */
            max-height: 100%; /* Ensure the canvas does not exceed the modal height */
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <h1>Upload PDF, Image, or CSV and Select Positions</h1>
        <form id="positionSelectionForm" action="/admin_Dashboard/uploadCertificates" method="post" enctype="multipart/form-data">
            <input type="file" id="fileInput" name="pdfFileInput" accept=".pdf,.png,.jpeg,.csv" required>
            <button type="button" id="uploadFileButton">Upload File</button>

            <input type="file" id="csvFileInput" name="csvFileInput" accept=".csv, .xlsx" required>            
            <button type="button" id="uploadCsvButton">Upload CSV File</button>

            <button type="button" id="selectPositionName" name="selectPositionName" onclick="selectPosition('name')">Select Name Position</button>
            <button type="button" id="selectPositionEvent" name="selectPositionEvent" onclick="selectPosition('event')">Select Event Position</button>
            <button type="button" id="selectPositionDate" name="selectPositionDate" onclick="selectPosition('date')">Select Date Position</button>

            <button type="button" id="finishSelection" name="finishSelection" style="display: none;">Finish Selection</button>
            <button type="button" id="cancelSelection" name="cancelSelection" style="display: none;">Cancel Selection</button>

            <!-- Hidden input fields for coordinates -->
            <input type="hidden" id="namePositionXInput" name="namePositionX">
            <input type="hidden" id="namePositionYInput" name="namePositionY">
            <input type="hidden" id="eventPositionXInput" name="eventPositionX">
            <input type="hidden" id="eventPositionYInput" name="eventPositionY">
            <input type="hidden" id="datePositionXInput" name="datePositionX">
            <input type="hidden" id="datePositionYInput" name="datePositionY">

            <button type="button" id="previewCoordinatesButton">Preview Coordinates</button>
            <button type="submit" id="submitButton" name="submitButton">Submit</button>
        </form>

        <div id="pdfModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closePdfModal()">&times;</span>
                <div id="pdfViewer"></div>
            </div>
        </div>
    </div>

    <script>
        let selectedPosition = '';
    
        function selectPosition(position) {
            selectedPosition = position;
            document.getElementById('pdfModal').style.display = 'block';
            // Load the uploaded PDF file into the PDF viewer
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                const pdfData = event.target.result;
                renderPdf(pdfData);
            };
            reader.readAsArrayBuffer(file);
        }
    
        function renderPdf(pdfData) {
            pdfjsLib.getDocument({ data: pdfData }).promise.then(function(pdf) {
                pdf.getPage(1).then(function(page) {
                    const canvas = document.createElement('canvas');
                    const viewport = page.getViewport({ scale: 1 });
                    const context = canvas.getContext('2d');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
    
                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };
    
                    page.render(renderContext).promise.then(function() {
                        // Add event listener to the canvas to capture the coordinates
                        canvas.addEventListener('click', function(event) {
                            const rect = canvas.getBoundingClientRect();
                            const x = event.clientX - rect.left; // X coordinate relative to the canvas
                            const y = event.clientY - rect.top; // Y coordinate relative to the canvas
    
                            // Update the input fields with the selected coordinates based on the selected position
                            switch (selectedPosition) {
                                case 'name':
                                    document.getElementById('namePositionXInput').value = x;
                                    document.getElementById('namePositionYInput').value = y;
                                    break;
                                case 'event':
                                    document.getElementById('eventPositionXInput').value = x;
                                    document.getElementById('eventPositionYInput').value = y;
                                    break;
                                case 'date':
                                    document.getElementById('datePositionXInput').value = x;
                                    document.getElementById('datePositionYInput').value = y;
                                    break;
                                default:
                                    break;
                            }
    
                            // Close the modal popup
                            closePdfModal();
                        });
    
                        // Append the canvas to the PDF viewer div
                        const pdfViewer = document.getElementById('pdfViewer');
                        pdfViewer.innerHTML = ''; // Clear previous content
                        pdfViewer.appendChild(canvas);
                    });
                });
            });
        }
    
        function closePdfModal() {
            document.getElementById('pdfModal').style.display = 'none';
            selectedPosition = ''; // Reset selected position
        }
    
        // Add event listener to handle form submission
        document.getElementById('positionSelectionForm').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent default form submission
    
            // Validate if all positions are selected
            if (document.getElementById('namePositionXInput').value === '' || 
                document.getElementById('eventPositionXInput').value === '' || 
                document.getElementById('datePositionXInput').value === '') {
                alert('Please select all positions before submitting.');
                return;
            }
    
            // Submit the form
            this.submit();
        });
    </script>    
</body>
</html>
